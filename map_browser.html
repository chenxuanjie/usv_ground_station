<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>USV Control & Map</title>
    <style type="text/css">
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        
        /* 左侧控制面板 */
        #control-panel {
            position: absolute;
            top: 10px; left: 10px;
            width: 300px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 999;
            font-family: "Microsoft YaHei", sans-serif;
            font-size: 14px;
        }
        
        #control-panel h3 { margin: 0 0 10px 0; font-size: 16px; color: #333; }
        
        .input-group { margin-bottom: 10px; }
        .input-group label { display: inline-block; width: 60px; }
        .input-group input { width: 140px; padding: 4px; border: 1px solid #ccc; border-radius: 4px; }
        
        button {
            background-color: #007bff; color: white;
            border: none; padding: 6px 12px;
            border-radius: 4px; cursor: pointer;
            width: 100%; margin-top: 5px;
        }
        button:hover { background-color: #0056b3; }
        button.disconnect { background-color: #dc3545; }
        button.disconnect:hover { background-color: #c82333; }

        #status-display {
            margin-top: 10px;
            padding: 8px;
            background: #f8f9fa;
            border: 1px solid #eee;
            border-radius: 4px;
            color: #666;
            font-size: 12px;
        }

        /* 地图容器 */
        #container { height: 100%; width: 100%; }
    </style>
    
    <!-- 百度地图 API -->
    <script type="text/javascript" src="http://api.map.baidu.com/getscript?v=3.0&ak=zaL1UjUlAdknPEVP5HBNRleQGj5le1La"></script>
    <script type="text/javascript" src="CoordinateTransform.js"></script>
</head>
<body>

    <!-- 控制面板 (恢复了IP/端口设置) -->
    <div id="control-panel">
        <h3>USV 控制台</h3>
        <div class="input-group">
            <label>Boat IP:</label>
            <input type="text" id="boat-ip" value="120.77.0.8">
        </div>
        <div class="input-group">
            <label>Port:</label>
            <input type="text" id="boat-port" value="6204">
        </div>
        <button id="connect-btn" onclick="toggleConnection()">连接船端 (TCP)</button>
        
        <div id="status-display">
            TCP状态: <span id="tcp-status" style="color:gray">未知</span><br>
            地图推流: <span id="stream-status" style="color:gray">未连接</span><br>
            坐标: <span id="pos-info">-</span>
        </div>
    </div>

    <!-- 地图容器 -->
    <div id="container"></div>

<script type="text/javascript">
    // === 1. 初始化地图 ===
    var map = new BMap.Map("container");
    var initPoint = new BMap.Point(113.3957, 23.0344);
    map.centerAndZoom(initPoint, 16);
    map.enableScrollWheelZoom();
    
    // 船只标记
    var boatMarker = new BMap.Marker(initPoint);
    var boatIcon = new BMap.Symbol(BMap_Symbol_SHAPE_FORWARD_CLOSED_ARROW, {
        scale: 1.5,
        strokeWeight: 1,
        fillColor: "red",
        fillOpacity: 0.8
    });
    boatMarker.setIcon(boatIcon);
    map.addOverlay(boatMarker);

    // === 2. 逻辑控制 ===
    var ws = null; // WebSocket 用于控制指令
    var streamSource = null; // SSE 用于地图数据
    var isTcpConnected = false;

    // 页面加载时获取配置
    window.onload = function() {
        initWebSocket(); // 先建立控制通道
        connectMapStream(); // 建立地图数据流
    };

    function initWebSocket() {
        // 连接到当前页面的 WebSocket 服务
        ws = new WebSocket("ws://" + location.host);
        
        ws.onopen = function() {
            console.log("WebSocket Connected");
            ws.send("GET_CONFIG"); // 获取后端当前配置
        };
        
        ws.onmessage = function(evt) {
            // 解析协议
            // 格式可能是: "CURRENT_CONFIG,1.2.3.4,8080" 或 "TCP_STATUS,ONLINE"
            var msg = evt.data;
            
            if (msg.startsWith("CURRENT_CONFIG")) {
                var parts = msg.split(",");
                if (parts.length >= 3) {
                    document.getElementById('boat-ip').value = parts[1];
                    document.getElementById('boat-port').value = parts[2];
                }
            } else if (msg.startsWith("TCP_STATUS")) {
                var status = msg.split(",")[1];
                var statusSpan = document.getElementById('tcp-status');
                var btn = document.getElementById('connect-btn');
                
                if (status === "ONLINE") {
                    statusSpan.innerHTML = "<b style='color:green'>在线</b>";
                    btn.innerText = "断开连接";
                    btn.className = "disconnect";
                    isTcpConnected = true;
                } else if (status === "OFFLINE") {
                    statusSpan.innerHTML = "<span style='color:gray'>离线</span>";
                    btn.innerText = "连接船端 (TCP)";
                    btn.className = "";
                    isTcpConnected = false;
                } else if (status === "FAILED") {
                    statusSpan.innerHTML = "<b style='color:red'>连接失败</b>";
                    btn.innerText = "重试连接";
                    btn.className = "";
                    isTcpConnected = false;
                }
            }
        };
    }

    function toggleConnection() {
        if (!ws) return;
        
        if (isTcpConnected) {
            ws.send("CMD,DISCONNECT");
        } else {
            var ip = document.getElementById('boat-ip').value;
            var port = document.getElementById('boat-port').value;
            ws.send("CMD,CONNECT," + ip + "," + port);
            document.getElementById('tcp-status').innerText = "连接中...";
        }
    }

    // === 3. 地图数据流 (SSE) - 无重连 ===
    function connectMapStream() {
        var statusSpan = document.getElementById('stream-status');
        
        // 如果已存在，先关闭
        if (streamSource) streamSource.close();

        streamSource = new EventSource("/stream");

        streamSource.onopen = function() {
            statusSpan.innerHTML = "<span style='color:green'>接收中</span>";
        };

        streamSource.onmessage = function(e) {
            try {
                var data = JSON.parse(e.data);
                if (data.lng && data.lat) {
                    updateMapPosition(data.lng, data.lat, data.course || 0);
                }
            } catch(err) {}
        };

        streamSource.onerror = function() {
            statusSpan.innerHTML = "<span style='color:red'>已断开</span>";
            console.log("Stream disconnected. Not reconnecting.");
            
            // [关键] 关闭连接，且不进行重连逻辑
            streamSource.close(); 
            streamSource = null;
        };
    }

    function updateMapPosition(lng, lat, course) {
        if (typeof wgs84tobd09 !== 'function') return;

        var bdPos = wgs84tobd09(lng, lat);
        var pt = new BMap.Point(bdPos[0], bdPos[1]);
        
        boatMarker.setPosition(pt);
        boatMarker.setRotation(course);
        
        document.getElementById('pos-info').innerText = 
            lng.toFixed(5) + ", " + lat.toFixed(5);
    }

</script>
</body>
</html>