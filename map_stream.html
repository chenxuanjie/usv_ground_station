<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>USV Real-time Map</title>
    <style type="text/css">
        html {height: 100%}
        body {height: 100%;margin: 0px;padding: 0px}
        #container {height: 100%}
        /* 添加一个简单的状态显示条 */
        #status-bar {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 999;
        }
    </style>
    <!-- 百度地图 API -->
    <script type="text/javascript" src="http://api.map.baidu.com/getscript?v=3.0&ak=zaL1UjUlAdknPEVP5HBNRleQGj5le1La"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/library/DistanceTool/1.2/src/DistanceTool_min.js"></script>
    <!-- 坐标转换 (必须保留) -->
    <script type="text/javascript" src="CoordinateTransform.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.js"></script>
    <link rel="stylesheet" href="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.css" />
    <!-- 移除了 qwebchannel.js，因为我们在 C++ Socket 模式下用不上它 -->
</head>
<body>
    <div id="status-bar">等待连接流数据...</div>
    <div id="container"></div>

<script type="text/javascript">
    // -----------------------------------------------------------
    // 1. 地图初始化 (保留你原有的逻辑)
    // -----------------------------------------------------------
    var map = new BMap.Map("container");
    // 默认中心点，稍后收到数据会自动更新
    map.centerAndZoom(new BMap.Point(113.39570966, 23.03447991), 16); 
    map.enableScrollWheelZoom();
    map.disableDoubleClickZoom();
    map.addControl(new BMap.NavigationControl({ type: BMAP_NAVIGATION_CONTROL_LARGE, showZoomInfo: true }));
    map.addControl(new BMap.MapTypeControl({ mapTypes: [BMAP_NORMAL_MAP, BMAP_HYBRID_MAP], anchor: BMAP_ANCHOR_TOP_LEFT, offset: new BMap.Size(80, 50)}));
    map.addControl(new BMap.ScaleControl({ anchor: BMAP_ANCHOR_TOP_LEFT }));

    // 船只图标定义
    var boatMarker = new BMap.Marker;
    var boatIcon = new BMap.Symbol(BMap_Symbol_SHAPE_FORWARD_CLOSED_ARROW, {
        scale: 1.5,
        strokeWeight: 1,
        fillColor: "red",
        fillOpacity: 0.8
    });
    var boatPoints = new Array(); 
    var boatTrackPolyline = new BMap.Polyline([], { strokeColor: "green", strokeWeight: 2, strokeOpacity: 0.5 });

    // -----------------------------------------------------------
    // 2. 核心功能: 更新船只位置 (保留原逻辑，供 SSE 调用)
    // -----------------------------------------------------------
    function showBoatPosition(lng, lat, course) {
        // [关键]: 使用 CoordinateTransform.js 将 WGS84 转为 百度坐标
        var currentPosition = wgs84tobd09(lng, lat);
        var currentPoint = new BMap.Point(currentPosition[0], currentPosition[1]);
        
        // 更新图标位置和角度
        boatIcon.setRotation(course);
        boatMarker.setIcon(boatIcon);
        boatMarker.setPosition(currentPoint);
        map.addOverlay(boatMarker);
        
        // 只有第一次收到数据时，自动移动地图视角到船的位置
        if (boatPoints.length === 0) {
            map.panTo(currentPoint);
        }

        // 绘制轨迹
        boatPoints.push(currentPoint);
        if (boatPoints.length == 1) {
            boatTrackPolyline.setPath(boatPoints);
            map.addOverlay(boatTrackPolyline);                
        } else if(boatPoints.length > 1) {
            boatTrackPolyline.setPath(boatPoints);
        }

        // 更新状态栏
        document.getElementById('status-bar').innerText = 
            "LNG: " + lng.toFixed(6) + " | LAT: " + lat.toFixed(6) + " | Angle: " + course.toFixed(1) + "°";
    }

    // -----------------------------------------------------------
    // 3. 新增功能: SSE (Server-Sent Events) 监听
    // -----------------------------------------------------------
    function connectToStream() {
        // 连接到后端的 /stream 路径
        var eventSource = new EventSource('/stream');

        eventSource.onopen = function() {
            console.log("Stream connected!");
            document.getElementById('status-bar').innerText = "已连接到 USV 数据流";
        };

        eventSource.onmessage = function(event) {
            try {
                // 解析后端发来的 JSON: {"lng":..., "lat":..., "course":...}
                var data = JSON.parse(event.data);
                
                // 检查数据完整性
                if (data.lng !== undefined && data.lat !== undefined) {
                    showBoatPosition(data.lng, data.lat, data.course || 0);
                }
            } catch (e) {
                console.error("Data parse error:", e);
            }
        };

        eventSource.onerror = function(err) {
            console.error("Stream failed:", err);
            document.getElementById('status-bar').innerText = "连接断开，正在重连...";
            eventSource.close();
            // 2秒后重连
            setTimeout(connectToStream, 2000);
        };
    }

    // 页面加载完成后立即启动连接
    connectToStream();

</script>
</body>
</html>